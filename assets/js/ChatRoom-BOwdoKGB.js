import{d as e,c as a,C as t,_ as s,w as n,s as o,r as i,l as r,p as l,A as c,v as d,T as u,U as m,F as p,z as g,u as b,V as v,P as h,q as f}from"./vue-CRY8e6yQ.js";import{b as y,d as w,e as k,c as R,a as x,u as S}from"./useLang-TYcMKtwz.js";import{_ as C}from"./index-CmndrdId.js";import"./gun-YLGCaVQN.js";import"./vendor-BzQRwhDR.js";async function N(e){const a=(new TextEncoder).encode(e);return function(e){const a=e instanceof Uint8Array?e:new Uint8Array(e);let t="";for(let s=0;s<a.length;s++)t+=String.fromCharCode(a[s]);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}(await crypto.subtle.digest("SHA-256",a))}let I=null;function P(){if(I)return I;const o=y(),i=e({rooms:[],messagesMap:{},currentRoomId:"",newRoomName:"",joinInput:"",sending:!1,polling:!1,lastPollAt:0}),r=a(()=>i.rooms.find(e=>e.id===i.currentRoomId)||null),l=a(()=>i.messagesMap[i.currentRoomId]||[]);async function c(){i.rooms=await w.textRooms.toArray()}async function d(e){const a=await w.textMessages.where({roomId:e}).sortBy("ts");i.messagesMap[e]=a}function u(e){i.currentRoomId=e,d(e)}const m=new Set;let p=null;async function g(e,a){if(!e||!e.id||!e.data)return;if(m.has(e.id))return;let t;try{t=JSON.parse(e.data)}catch(s){return}if(t&&"room"===t.scheme&&t.payload&&t.rpub){const n=i.rooms.find(e=>e.rpub===t.rpub);if(!n)return;try{const r=await R(t.payload,n.rpriv),l=JSON.parse(r);if("mesh:text"!==l.t||l.roomId!==n.id)return;if(l.sig&&l.fromPub){if(!(await o.crypto.verify(`${l.roomId}:${l.msg}:${l.ts}`,l.sig,l.fromPub)))return}let d=(i.messagesMap[l.roomId]||[]).some(e=>e.ts===l.ts&&e.senderPub===l.fromPub);if(!d){d=!!(await w.textMessages.where({roomId:l.roomId}).and(e=>e.ts===l.ts&&e.senderPub===l.fromPub).first())}if(!d){const a={roomId:l.roomId,senderPub:l.fromPub,content:l.msg,raw:e.data,ts:l.ts},t=await w.textMessages.add(a);a.id=t,i.messagesMap[l.roomId]=[...i.messagesMap[l.roomId]||[],a],await w.textRooms.update(n.id,{updatedAt:Date.now()}),await c()}m.add(e.id);try{const t=(o.servers||[]).filter(e=>e.enabled);await Promise.all(t.map(async t=>{const n=t.url.replace(/\/$/,""),o=a?.replace(/\/$/,"");if(!o||n!==o)try{await fetch(`${n}/pool/message`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e.id,data:e.data})})}catch(s){}}))}catch(s){}}catch(s){}return}}async function b(){if(!i.polling){i.polling=!0;try{const e=(o.servers||[]).filter(e=>e.enabled);await Promise.all(e.map(async e=>{try{const a=await fetch(`${e.url.replace(/\/$/,"")}/pool/list`);if(!a.ok)return;const t=await a.json(),s=Array.isArray(t?.messages)?t.messages:[];for(const n of s)await g(n,e.url)}catch(a){}})),i.lastPollAt=Date.now()}finally{i.polling=!1}}}function v(){p&&(clearInterval(p),p=null)}return t(async()=>{await c(),i.rooms[0]?.id&&u(i.rooms[0].id),v(),p=setInterval(b,4e3)}),s(()=>{v()}),n(()=>o.servers.map(e=>`${e.url}:${e.enabled}`).join(","),()=>{b()}),I=i,Object.assign(I,{currentRoom:r,currentMessages:l,loadRooms:c,loadMessages:d,selectRoom:u,createTextRoom:async function(){const e=i.newRoomName.trim()||"未命名文本房间",a=await o.crypto.generatePair(),t=String(a.epub),s=String(a.epriv),n=Date.now(),r=t;await w.textRooms.get(r)?await w.textRooms.update(r,{name:e,updatedAt:n}):await w.textRooms.add({id:r,ownerUserId:o.currentUser.id,name:e,rpub:t,rpriv:s,createdAt:n,updatedAt:n}),await c(),i.newRoomName=""},joinTextRoomByJSON:async function(){let e;try{e=JSON.parse(i.joinInput)}catch(n){return void alert("加入失败：请粘贴包含 rpub/rpriv 的 JSON")}if(!e||!e.rpub||!e.rpriv)return void alert("加入失败：缺少 rpub/rpriv 字段");const a=Date.now(),t=String(e.rpub),s=String(e.name||"外部房间");await w.textRooms.get(t)?await w.textRooms.update(t,{name:s,updatedAt:a}):await w.textRooms.add({id:t,ownerUserId:o.currentUser.id,name:s,rpub:String(e.rpub),rpriv:String(e.rpriv),createdAt:a,updatedAt:a}),await c(),i.joinInput=""},sendTextMessage:async function(){const e=r.value;if(!e)return;const a=prompt("输入要发送的消息：","")||"";if(a.trim())try{i.sending=!0;const t=Date.now(),s=`${e.id}:${a}:${t}`,n=await o.crypto.sign(s,o.currentUser.priv),r={t:"mesh:text",roomId:e.id,msg:a,fromPub:o.currentUser.pub,ts:t,sig:n},l=await k(JSON.stringify(r),{epub:e.rpub}),d={scheme:"room",roomId:e.id,rpub:e.rpub,payload:l},u=JSON.stringify(d),m=await N(u);await Promise.all((o.servers||[]).filter(e=>e.enabled).map(async e=>{const a=`${e.url.replace(/\/$/,"")}/pool/message`;try{await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:m,data:u})})}catch(t){}}));const p={roomId:e.id,senderPub:o.currentUser.pub,content:a,raw:u,ts:t},g=await w.textMessages.add(p);p.id=g,i.messagesMap[e.id]=[...i.messagesMap[e.id]||[],p],await w.textRooms.update(e.id,{updatedAt:Date.now()}),await c()}finally{i.sending=!1}},pollOnce:b}),I}const j={class:"sessions-page"},O={style:{display:"flex","justify-content":"flex-end","margin-bottom":"8px"}},U={key:0,class:"auth-section"},J={class:"card auth-card"},M={class:"desc"},T={class:"auth-form"},$={class:"h2"},A={class:"small muted"},E=["disabled"],D=["disabled"],L={class:"auth-form"},_={class:"h2"},V={class:"small muted"},B=["placeholder","disabled"],W=["disabled"],z={key:1,class:"main-section"},q={class:"user-bar card"},F={class:"user-info"},G={class:"h2"},H={class:"small muted"},Z={class:"room-actions card"},K={class:"grid-2"},Q={class:"h3"},X={class:"row gap mt-8"},Y=["placeholder"],ee=["placeholder"],ae={class:"h3"},te={class:"row gap mt-8"},se=["placeholder"],ne={class:"sessions-list card"},oe={class:"h3"},ie={key:0,class:"empty-state"},re={class:"muted"},le={key:1,class:"sessions-items"},ce=["onClick"],de={class:"session-content"},ue={class:"session-name"},me={class:"session-last-msg"},pe={class:"session-meta"},ge={class:"session-time"},be={key:0,class:"session-signaling"},ve={class:"session-actions"},he=["onClick"],fe={class:"mesh-chat card mt-16"},ye={class:"row space-between align-center"},we={class:"h3"},ke={class:"small muted"},Re={class:"server-manage mt-12"},xe={class:"h4"},Se={class:"row gap mt-8"},Ce=["placeholder"],Ne={key:0,class:"servers mt-8"},Ie={class:"bold"},Pe={class:"small muted"},je={class:"row gap"},Oe=["onClick"],Ue=["onClick"],Je=["onClick"],Me={class:"grid-2 mt-16"},Te={class:"h4"},$e={class:"row gap mt-8"},Ae=["placeholder"],Ee={class:"row gap mt-8"},De=["placeholder"],Le={class:"rooms mt-12"},_e=["onClick"],Ve={class:"bold"},Be={class:"small muted"},We={class:"small"},ze={class:"h4"},qe={class:"messages"},Fe={key:0},Ge={class:"small muted"},He={class:"row gap mt-8"},Ze=["disabled"],Ke=["disabled"],Qe={key:0,class:"row gap mt-8"},Xe=C(o({__name:"ChatRoom",setup(e){const{isZh:s,toggle:n}=x(),o=()=>n(),w=a(()=>s.value?'粘贴文本房间 JSON：{"rpub":"...","rpriv":"..."}':'Paste text room JSON: {"rpub":"...","rpriv":"..."}'),k=y(),R=S(),C=h(),N=P(),I=i("");async function Xe(){const e=await k.loginWithPair(k.loginPairText);e.ok?k.loginPairText="":alert(e.message||(s.value?"登录失败":"Login failed"))}async function Ye(){const e=await k.registerNew(k.registerNickname);e.ok?k.registerNickname="":alert(e.message||(s.value?"注册失败":"Register failed"))}async function ea(){const e=await R.joinByShare(R.joinInput);e.ok||alert(e.message||(s.value?"加入失败":"Join failed"))}function aa(e){const a=R.messagesMap[e]||[];if(0===a.length)return s.value?"暂无消息":"No messages";const t=a[a.length-1];return t.content.length>30?t.content.slice(0,30)+"...":t.content}function ta(e){const a=Date.now()-e;return a<6e4?s.value?"刚刚":"just now":a<36e5?s.value?`${Math.floor(a/6e4)} 分钟前`:`${Math.floor(a/6e4)} minutes ago`:a<864e5?s.value?`${Math.floor(a/36e5)} 小时前`:`${Math.floor(a/36e5)} hours ago`:s.value?`${Math.floor(a/864e5)} 天前`:`${Math.floor(a/864e5)} days ago`}function sa(){I.value.trim()&&(k.addServer(I.value),I.value="")}async function na(){const e=N.currentRoom;if(!e)return;const a={name:e.name,rpub:e.rpub,rpriv:e.rpriv},t=JSON.stringify(a);try{await navigator.clipboard.writeText(t),alert(s.value?"已复制房间 JSON，邀请方可在“粘贴文本房间 JSON”框中粘贴加入。":'Room JSON copied. Invitee can paste it into the "Paste text room JSON" box to join.')}catch(n){prompt(s.value?"复制失败，请手动复制以下内容：":"Copy failed, please copy manually:",t)}}async function oa(){const e=N.currentRoom;if(!e)return;const a={name:e.name,rpub:e.rpub,rpriv:e.rpriv},t=encodeURIComponent(JSON.stringify(a)),n=`${`${location.origin}${location.pathname}`}?mesh_text_room=${t}`;try{await navigator.clipboard.writeText(n),alert(s.value?"已复制分享链接，受邀者打开后将自动填充加入框（仍需点击加入）。":"Share link copied. The invitee can open it to auto-fill the join box (still need to click Join).")}catch(o){prompt(s.value?"复制失败，请手动复制以下链接：":"Copy failed, please copy this link:",n)}}return t(()=>{try{const e=new URLSearchParams(location.search).get("mesh_text_room");if(e)try{N.joinInput=decodeURIComponent(e)}catch{N.joinInput=e}}catch(e){}}),(e,a)=>(f(),r("div",j,[l("div",O,[l("button",{class:"btn",onClick:o},c(d(s)?"EN":"中文"),1)]),d(k).isAuthed?(f(),r("div",z,[l("div",q,[l("div",F,[l("h2",G,c(d(k).currentUser?.nickname||(d(s)?"未知用户":"Unknown user")),1),l("p",H,c((d(k).currentUser?.pub?.slice(0,16)||"")+"..."),1)]),l("button",{class:"btn btn-outline",onClick:a[2]||(a[2]=(...e)=>d(k).logout&&d(k).logout(...e))},c(d(s)?"退出登录":"Log out"),1)]),l("div",Z,[l("div",K,[l("div",null,[l("h3",Q,c(d(s)?"创建房间":"Create room"),1),l("div",X,[u(l("input",{"onUpdate:modelValue":a[3]||(a[3]=e=>d(R).createRoomName=e),class:"input flex1",placeholder:d(s)?"房间名称":"Room name"},null,8,Y),[[m,d(R).createRoomName]]),l("button",{class:"btn btn-primary",onClick:a[4]||(a[4]=(...e)=>d(R).createRoom&&d(R).createRoom(...e))},c(d(s)?"创建":"Create"),1)]),u(l("input",{"onUpdate:modelValue":a[5]||(a[5]=e=>d(R).createRoomSignaling=e),class:"input mt-8",placeholder:d(s)?"信令地址（可选）":"Signaling URL (optional)"},null,8,ee),[[m,d(R).createRoomSignaling]])]),l("div",null,[l("h3",ae,c(d(s)?"加入房间":"Join room"),1),l("div",te,[u(l("input",{"onUpdate:modelValue":a[6]||(a[6]=e=>d(R).joinInput=e),class:"input flex1",placeholder:d(s)?"粘贴分享链接或JSON":"Paste share link or JSON"},null,8,se),[[m,d(R).joinInput]]),l("button",{class:"btn btn-outline",onClick:ea},c(d(s)?"加入":"Join"),1)])])])]),l("div",ne,[l("h3",oe,c(d(s)?"会话列表":"Sessions"),1),0===d(R).rooms.length?(f(),r("div",ie,[l("p",re,c(d(s)?"暂无会话，请创建或加入房间":"No sessions yet. Create or join a room."),1)])):(f(),r("div",le,[(f(!0),r(p,null,g(d(R).rooms,e=>(f(),r("div",{key:e.id,class:"session-item",onClick:a=>{return t=e.id,void C.push(`/room/${t}`);var t}},[l("div",de,[l("h4",ue,c(e.name),1),l("p",me,c(aa(e.id)),1),l("div",pe,[l("span",ge,c(ta(e.updatedAt)),1),e.manualSignalingUrl?(f(),r("span",be," • "+c(e.manualSignalingUrl),1)):b("",!0)])]),l("div",ve,[l("button",{class:"btn btn-outline btn-danger",onClick:v(a=>async function(e){confirm(s.value?"确认删除该会话及其所有消息？此操作不可恢复。":"Delete this session and all messages? This action cannot be undone.")&&await R.deleteRoom(e)}(e.id),["stop"])},c(d(s)?"删除":"Delete"),9,he)]),a[15]||(a[15]=l("div",{class:"session-arrow"},"→",-1))],8,ce))),128))]))]),l("div",fe,[l("div",ye,[l("h3",we,c(d(s)?"网状聊天（文本 Beta）":"Mesh chat (Text Beta)"),1),l("div",ke,c(d(s)?"上次同步：":"Last sync: ")+c(d(N).lastPollAt?ta(d(N).lastPollAt):d(s)?"从未":"Never"),1)]),l("div",Re,[l("h4",xe,c(d(s)?"服务端连接":"Server connections"),1),l("div",Se,[u(l("input",{"onUpdate:modelValue":a[7]||(a[7]=e=>I.value=e),class:"input flex1",placeholder:d(s)?"输入服务端 URL，如 http://127.0.0.1:3030":"Enter server URL, e.g. http://127.0.0.1:3030"},null,8,Ce),[[m,I.value]]),l("button",{class:"btn btn-outline",onClick:sa},c(d(s)?"添加":"Add"),1)]),d(k).servers.length?(f(),r("div",Ne,[(f(!0),r(p,null,g(d(k).servers,e=>(f(),r("div",{key:e.url,class:"server-item row space-between align-center"},[l("div",null,[l("div",Ie,c(e.url),1),l("div",Pe,c(d(s)?"状态：":"Status: ")+c(e.lastStatus||"unknown")+c(d(s)?"，":", ")+c(e.enabled?d(s)?"已启用":"enabled":d(s)?"已禁用":"disabled"),1)]),l("div",je,[l("button",{class:"btn btn-outline",onClick:a=>{return t=e.url,s=!e.enabled,void k.setServerEnabled(t,s);var t,s}},c(e.enabled?d(s)?"禁用":"Disable":d(s)?"启用":"Enable"),9,Oe),l("button",{class:"btn",onClick:a=>async function(e){await k.pingServer(e)}(e.url)},"Ping",8,Ue),l("button",{class:"btn btn-danger",onClick:a=>{return t=e.url,void k.removeServer(t);var t}},c(d(s)?"删除":"Delete"),9,Je)])]))),128))])):b("",!0)]),l("div",Me,[l("div",null,[l("h4",Te,c(d(s)?"文本房间":"Text rooms"),1),l("div",$e,[u(l("input",{"onUpdate:modelValue":a[8]||(a[8]=e=>d(N).newRoomName=e),class:"input flex1",placeholder:d(s)?"新建房间名称":"New room name"},null,8,Ae),[[m,d(N).newRoomName]]),l("button",{class:"btn btn-primary",onClick:a[9]||(a[9]=(...e)=>d(N).createTextRoom&&d(N).createTextRoom(...e))},c(d(s)?"新建":"Create"),1)]),l("div",Ee,[u(l("input",{"onUpdate:modelValue":a[10]||(a[10]=e=>d(N).joinInput=e),class:"input flex1",placeholder:w.value},null,8,De),[[m,d(N).joinInput]]),l("button",{class:"btn btn-outline",onClick:a[11]||(a[11]=(...e)=>d(N).joinTextRoomByJSON&&d(N).joinTextRoomByJSON(...e))},c(d(s)?"加入":"Join"),1)]),l("div",Le,[(f(!0),r(p,null,g(d(N).rooms,e=>(f(),r("div",{key:e.id,class:"room-item row space-between align-center",onClick:a=>d(N).selectRoom(e.id)},[l("div",null,[l("div",Ve,c(e.name),1),l("div",Be,c(e.id.slice(0,16))+"...",1)]),l("div",We,c(d(N).currentRoomId===e.id?d(s)?"当前":"Current":d(s)?"进入":"Enter"),1)],8,_e))),128))])]),l("div",null,[l("h4",ze,c(d(s)?"消息":"Messages"),1),l("div",qe,[d(N).currentRoom?(f(!0),r(p,{key:1},g(d(N).currentMessages,e=>(f(),r("div",{class:"message",key:e.id},[l("div",Ge,c(e.senderPub.slice(0,8))+" • "+c(ta(e.ts)),1),l("div",null,c(e.content),1)]))),128)):(f(),r("div",Fe,c(d(s)?"请选择一个文本房间":"Please select a text room"),1))]),l("div",He,[l("button",{class:"btn btn-primary",disabled:!d(N).currentRoom||d(N).sending,onClick:a[12]||(a[12]=(...e)=>d(N).sendTextMessage&&d(N).sendTextMessage(...e))},c(d(N).sending?d(s)?"发送中...":"Sending...":d(s)?"发送消息":"Send message"),9,Ze),l("button",{class:"btn",disabled:d(N).polling,onClick:a[13]||(a[13]=(...e)=>d(N).pollOnce&&d(N).pollOnce(...e))},c(d(N).polling?d(s)?"同步中...":"Syncing...":d(s)?"立即同步":"Sync now"),9,Ke)]),d(N).currentRoom?(f(),r("div",Qe,[l("button",{class:"btn",onClick:na},c(d(s)?"复制房间 JSON":"Copy room JSON"),1),l("button",{class:"btn",onClick:oa},c(d(s)?"复制分享链接":"Copy share link"),1)])):b("",!0)])])])])):(f(),r("div",U,[l("div",J,[a[14]||(a[14]=l("h1",{class:"h1"},"MeshPath",-1)),l("p",M,c(d(s)?"基于 WebRTC + E2EE 的去中心化视频通话平台":"Decentralized video calls powered by WebRTC + E2EE"),1),l("div",T,[l("h2",$,c(d(s)?"用户登录":"Login"),1),l("p",A,c(d(s)?"使用现有密钥对登录":"Login with an existing key pair"),1),u(l("textarea",{"onUpdate:modelValue":a[0]||(a[0]=e=>d(k).loginPairText=e),class:"textarea",placeholder:'{"pub":"...","priv":"..."}',disabled:d(k).loading},null,8,E),[[m,d(k).loginPairText]]),l("button",{class:"btn btn-primary",onClick:Xe,disabled:d(k).loading||!d(k).loginPairText.trim()},c(d(k).loading?d(s)?"登录中...":"Logging in...":d(s)?"登录":"Login"),9,D)]),l("div",L,[l("h2",_,c(d(s)?"用户注册":"Register"),1),l("p",V,c(d(s)?"自动生成新密钥对并设置昵称":"Generate a new key pair and set a nickname"),1),u(l("input",{"onUpdate:modelValue":a[1]||(a[1]=e=>d(k).registerNickname=e),class:"input",placeholder:d(s)?"输入昵称":"Enter nickname",disabled:d(k).loading},null,8,B),[[m,d(k).registerNickname]]),l("button",{class:"btn btn-outline",onClick:Ye,disabled:d(k).loading||!d(k).registerNickname.trim()},c(d(k).loading?d(s)?"注册中...":"Registering...":d(s)?"注册":"Register"),9,W)])])]))]))}}),[["__scopeId","data-v-c586c58d"]]);export{Xe as default};
